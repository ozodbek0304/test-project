import{r as o,i as R,ae as $,G as p,af as x}from"./index-BuAxSJaU.js";function J(d,l,S,W,s){const[g,C]=o.useState(0),[w,k]=o.useState(!1),[b,h]=o.useState(0),[Q,a]=o.useState(void 0),i=o.useRef(null),u=R(),n=[d,S],P=$({queryKey:n,queryFn:async()=>(await p.get(d,{params:S,onDownloadProgress:e=>{if(e.total){const r=Math.round(e.loaded*100/e.total);C(r)}}})).data,...W,refetchOnMount:!0,refetchOnWindowFocus:!0,placeholderData:x});o.useEffect(()=>{const t=()=>{const e=`wss://api.shoshcargo.uz/ws/${l}`,r=new WebSocket(e);i.current=r,r.onopen=()=>{k(!0),h(0),a(void 0)},r.onmessage=c=>{try{const f=JSON.parse(c.data);y(f)}catch(f){console.error("Failed to parse WebSocket message:",f)}},r.onerror=()=>{a("WebSocket error occurred")},r.onclose=()=>{k(!1),b<5?setTimeout(()=>{h(c=>c+1),t()},5e3):a("WebSocket connection failed after 5 retries")}};return b<5&&l&&t(),()=>{var e;(e=i.current)==null||e.close()}},[]);const y=t=>{switch(t.action){case"c":M(t.data);break;case"u":q(t.data);break;case"d":F(t.data);break;default:console.warn(`Unhandled action type: ${t.action}`)}},M=t=>{s!=null&&s.isPaginated?u.setQueryData(n,e=>({...e,results:[...(e==null?void 0:e.results)||[],t]})):u.setQueryData(n,e=>e?[...e,t]:[t])},q=t=>{s!=null&&s.isPaginated?u.setQueryData(n,e=>({...e,results:((e==null?void 0:e.results)||[]).map(r=>r.id===t.id?t:r)})):u.setQueryData(n,e=>e&&e.map(r=>r.id===t.id?t:r))},F=t=>{const e=typeof t=="object"?t.id:t;s!=null&&s.isPaginated?u.setQueryData(n,r=>({...r,results:((r==null?void 0:r.results)||[]).filter(c=>c.id!==e)})):u.setQueryData(n,r=>r&&r.filter(c=>c.id!==e))};return{...P,isConnected:w,sendMessage:t=>{w&&i.current?i.current.send(JSON.stringify(t)):a("Cannot send message. WebSocket is not connected.")},wsError:Q,downloadProgress:g}}export{J as u};
