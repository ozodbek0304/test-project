import{i as K,k as Q,u as V,j as i,l as g,B as j,J as M,m as P,z as p,n as D,b as U,t as W,o as Y,r as z,D as X,p as Z,q as w,s as ee,V as ae,v as ie,g as se,F as B,w as A,x as G,C as R,y as E,T as ne,E as T,G as le,c as te}from"./index-BuAxSJaU.js";import{P as F}from"./tabs-xOTve4x4.js";import{C as L}from"./collapsible-table-Cv61XwvC.js";import{D as oe}from"./datatable-BQkt-0G4.js";import{B as re}from"./badge-EKaIYskS.js";import{u as ce}from"./usePrompt-Dl5wsuex.js";import{U as I}from"./undo-2-Ba1fajE1.js";import{P as N}from"./combobox-BXG5K80F.js";import{D as me}from"./download-as-excel-C7gdF7ep.js";import{F as q}from"./select-B7d_NQsS.js";import{M as H}from"./move-right-CEAOD2dZ.js";import{C as J}from"./pagination-BuI0EWJ8.js";import{u as de}from"./useConfirm-C4TJzy_o.js";import"./cursor-pagination-BTjgdc8e.js";import"./useDownloadAsExcel-B0QCkxlR.js";const ue=()=>{const t=K(),a=ce(),e=Q({from:"/_main"}),{post:n}=V();async function o(s,r){const d=await a();d&&M.promise(n(r?`checkout/rollback-paid-client-order/${s}/`:`checkout/rollback-paid-order/${s}/`,{comment:d}),{loading:"Qaytarilmoqda",success:()=>(t.setQueryData(["checkout/summary/",{...e,payment_type:e.type}],h=>({...h,results:h.results.map(l=>l.id==s?{...l,paid:r?l.paid:!l.paid,client_paid:r?!l.client_paid:l.client_paid}:l)})),t.invalidateQueries({queryKey:["checkout/balance-info/"]}),"Muvaffaqiyatli qaytarildi")})}return[{header:"№",cell:({row:s})=>s.index+1},{header:"Buyurtmachi",accessorKey:"client"},{header:"Qayerdan",accessorKey:"loading"},{header:"Qayerga",accessorKey:"unloading"},{header:"Mashina raqami",accessorKey:"car_number"},{header:"Kirim",cell:({row:s})=>i.jsxs("div",{className:"flex items-center",children:[g(s.original.income),s.original.client_paid&&i.jsx(j,{icon:i.jsx(I,{width:16}),variant:"ghost",size:"icon",className:"!text-destructive",onClick:()=>o(s.original.id,!0)})]})},{header:"Chiqim",cell:({row:s})=>i.jsxs("div",{className:"flex items-center",children:[g(s.original.total_amount),s.original.paid&&i.jsx(j,{icon:i.jsx(I,{width:16}),variant:"ghost",size:"icon",className:"!text-destructive",onClick:()=>o(s.original.id)})]})},{header:"Status",cell:({row:s})=>{var r;return(r=s.original)!=null&&r.paid?i.jsx("span",{className:"text-green-500",children:"To'landi"}):i.jsx("span",{className:"text-destructive",children:"To'lanmagan"})}},{header:"To'lov turi",cell:({row:s})=>{var r;return i.jsx(re,{children:((r=s.original)==null?void 0:r.payment_type)==="cash"?"Naqd":"Pul o'tkazma"})}}]},O=()=>{const{data:t}=P("common/points/");return{places:(t==null?void 0:t.map(e=>({...e,label:e.name,value:e.id})))||[]}};function pe({open:t,setOpen:a,current:e}){var f;const n=K(),o=Q({from:"/_main"}),{put:s,isPending:r}=V(),d=D().clients,h=(f=d==null?void 0:d.find(m=>m.label===(e==null?void 0:e.client)))==null?void 0:f.id,l=U({resolver:W(he),disabled:r}),{loadingRoutes:u,unloadingRoutes:x}=Y(h||l.watch("client"));z.useEffect(()=>{var m,v,b,_;e&&l.reset({...e,client:h,loading:(m=u==null?void 0:u.find(y=>y.label===(e==null?void 0:e.loading)))==null?void 0:m.value,unloading:(_=(b=x==null?void 0:x((v=u==null?void 0:u.find(y=>y.label==(e==null?void 0:e.loading)))==null?void 0:v.value))==null?void 0:b.find(y=>y.label===(e==null?void 0:e.unloading)))==null?void 0:_.value})},[e,l]);function C(){l.reset(),a(!1)}z.useEffect(()=>{t||l.reset()},[t,l]);async function c(m){await s(`checkout/summary/${e==null?void 0:e.id}/`,{...e,...m}),M.success("Muvaffaqiyatli o'zgartirildi"),a(!1),n.setQueryData(["checkout/summary/",{...o,payment_type:o.type}],v=>({...v,results:v.results.map(b=>{var _,y,S,$;return b.id==(e==null?void 0:e.id)?{...b,...m,income:(m==null?void 0:m.income)||(e==null?void 0:e.income),total_amount:(m==null?void 0:m.total_amount)||(e==null?void 0:e.total_amount),client:(_=d==null?void 0:d.find(k=>k.id==m.client))==null?void 0:_.label,loading:(y=u==null?void 0:u.find(k=>k.value==m.loading))==null?void 0:y.label,unloading:($=(S=x(m.loading))==null?void 0:S.find(k=>k.value==m.unloading))==null?void 0:$.label}:b})})),n.invalidateQueries({queryKey:["checkout/balance-info/"]})}return i.jsx(X,{open:t,onOpenChange:a,children:i.jsxs(Z,{children:[i.jsxs(w,{children:[i.jsx(ee,{children:"Reyestr"}),i.jsx(ae,{children:i.jsx(ie,{children:"Reyestr"})})]}),i.jsxs("form",{onSubmit:l.handleSubmit(c),className:"space-y-4 max-h-[90vh] overflow-y-auto px-0.5",children:[i.jsx(q,{control:l.control,name:"client",label:"Buyurtmachi",options:D().clients}),i.jsx(q,{control:l.control,name:"loading",label:"Yuklash manzili",options:u}),i.jsx(q,{control:l.control,name:"unloading",label:"Tushirish manzili",options:x(l.watch("loading"))}),i.jsx(se,{methods:l,name:"car_number",label:"Avtomobil raqami"}),i.jsx(B,{control:l.control,thousandSeparator:" ",name:"income",label:"Kirim"}),i.jsx(B,{control:l.control,thousandSeparator:" ",name:"total_amount",label:"Chiqim"}),i.jsx(q,{control:l.control,name:"payment_type",returnVal:"value",options:[{label:"Naqd",value:"cash"},{label:"Pul o'tkazma",value:"transfer"}]}),i.jsxs("div",{className:"flex gap-4 justify-end",children:[i.jsx(j,{loading:r,children:"Tasdiqlash"}),i.jsx(j,{variant:"secondary",type:"button",onClick:C,children:"Bekor qilish"})]})]})]})})}const he=p.object({client:p.number().min(1).or(p.string().min(1)),loading:p.number().min(1).or(p.string().min(1)),unloading:p.number().min(1).or(p.string().min(1)),car_number:p.string().min(1),income:p.string().or(p.number()),total_amount:p.string().or(p.number()),payment_type:p.string().min(1)}),ge=()=>{const[t,a]=z.useState(!1),[e,n]=z.useState(),o=Q({from:"/_main"}),{data:s,isLoading:r}=P("checkout/summary/",{...o,payment_type:o.type}),d=!!A().allPaths.includes("checkout/summary/");return i.jsxs(i.Fragment,{children:[i.jsx(oe,{columns:ue(),data:s==null?void 0:s.results,loading:r,onRowClick:h=>{n(h),a(!0)},paginationProps:{totalPages:(s==null?void 0:s.total_pages)||1},head:i.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[i.jsx(F,{paramName:"payment_type",options:[{label:"Naqd",value:"cash"},{label:"Pul o'tkazish",value:"transfer"},{label:"Reyestr",value:"reyestr"}].slice(0,d?3:2)}),i.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[i.jsx(N,{options:D().clients,paramName:"client",label:"Buyurtmachi"}),i.jsx(N,{options:O().places,paramName:"loading",label:"Qayerdan"}),i.jsx(N,{options:O().places,paramName:"unloading",label:"Qayerga"}),i.jsx(N,{options:[{label:"Naqd",value:"cash"},{label:"Pul o'tkazish",value:"transfer"}].slice(0,d?3:2),paramName:"type",label:"Kirim turi"}),i.jsx(me,{url:"checkout/summary-excel/",name:"Menejer_reyestr"})]})]})}),i.jsx(pe,{open:t,setOpen:a,current:e})]})},xe=({handlePay:t})=>[{header:"№",cell:({row:a})=>{var e;return a.original.name?a.index+1:(e=a.original.date)==null?void 0:e.split("/").join(".")}},{header:"Buyurtmachi",cell:({row:a})=>{var e;return(e=a.original)!=null&&e.name?a.original.name:i.jsxs("div",{className:"flex items-center gap-2",children:[a.original.loading_name," ",i.jsx(H,{width:18,className:"text-primary"})," ",a.original.unloading_name]})}},{header:" ",cell:({row:a})=>{var e;return a.original.name?"":(e=a.original)==null?void 0:e.car_number}},{header:"Qarzdorlik",cell:({row:a})=>{var e,n,o,s;return(e=a.original)!=null&&e.name?g((o=(n=a.original)==null?void 0:n.amounts)==null?void 0:o.sum_income):g(a.original.income,`${!((s=a.original)!=null&&s.invoice_status)&&"text-destructive"} ${a.original.invoice_status==="approved"&&"text-green-500"} ${a.original.invoice_status==="pending"&&"text-orange-400"}`)}},{header:"Chiqim",cell:({row:a})=>{var e,n,o;return(e=a.original)!=null&&e.name?g((o=(n=a.original)==null?void 0:n.amounts)==null?void 0:o.sum_total_amount):g(a.original.total_amount)}},{header:" ",cell:({row:a})=>{var e;return a.getCanExpand()?i.jsx(J,{className:G("text-muted-foreground",a.getIsExpanded()?"rotate-0":"-rotate-90")}):!((e=a.original)!=null&&e.paid)&&i.jsx(j,{variant:"ghost",className:"!text-green-500",onClick:()=>{var n;return t((n=a.original)==null?void 0:n.id,"chiqim")},icon:i.jsx(R,{width:18})})}}],ye=({handlePay:t})=>[{header:"№",cell:({row:a})=>{var e;return a.original.name?a.index+1:(e=a.original.date)==null?void 0:e.split("/").join(".")}},{header:"Buyurtmachi",cell:({row:a})=>{var e;return(e=a.original)!=null&&e.name?a.original.name:""}},{header:" ",cell:({row:a})=>a.original.name?"":i.jsxs("div",{className:"flex items-center gap-2",children:[a.original.loading_name," ",i.jsx(H,{width:18,className:"text-primary"})," ",a.original.unloading_name]})},{header:" ",cell:({row:a})=>a.original.name?"":a.original.car_number},{header:"Qarzdorlik",cell:({row:a})=>{var e,n,o,s,r;return(e=a.original)!=null&&e.name?g((o=(n=a.original)==null?void 0:n.amounts)==null?void 0:o.sum_income):i.jsxs("div",{className:"flex items-center",children:[g((s=a.original)==null?void 0:s.income)," ",E("checkout/pay-cash-order/$/")&&!((r=a.original)!=null&&r.client_paid)&&i.jsx(j,{icon:i.jsx(R,{width:16}),size:"sm",className:"!text-green-500",variant:"ghost",onClick:()=>t(a.original.id,"qarz")})]})}},{header:"Chiqim",cell:({row:a})=>{var e,n,o,s;return(e=a.original)!=null&&e.name?g((o=(n=a.original)==null?void 0:n.amounts)==null?void 0:o.sum_total_amount):i.jsxs("div",{className:"flex items-center",children:[g(a.original.total_amount)," ",E("checkout/pay-cash-order/$/")&&!((s=a.original)!=null&&s.paid)&&i.jsx(j,{icon:i.jsx(R,{width:16}),size:"sm",className:"!text-green-500",variant:"ghost",onClick:()=>t(a.original.id,"chiqim")})]})}},{header:" ",cell:({row:a})=>a.original.name&&a.getCanExpand()?i.jsx(J,{className:G("text-muted-foreground",a.getIsExpanded()?"rotate-0":"-rotate-90")}):""}],fe=()=>{var l,u,x,C;const t=Q({from:"/_main"}),a=de(),e=K(),{data:n,isLoading:o}=P("checkout/report-orders/",{...t,payment_type:"cash"},{enabled:t.payment_type!=="reyestr",refetchOnMount:!0,refetchOnWindowFocus:!0}),{data:s,isLoading:r}=P("checkout/report-orders/",{...t,payment_type:"transfer"},{enabled:t.payment_type!=="reyestr",refetchOnMount:!0,refetchOnWindowFocus:!0});async function d(c,f){await a({title:"Tasdiqlansinmi?"})&&M.promise(le.get(f==="qarz"?`checkout/pay-client-order/${c}/`:`checkout/pay-order/${c}/`).then(()=>{e.invalidateQueries({queryKey:["checkout/balance-info/"]})}),{loading:"Tasdiqlanmoqda",success:()=>(e.invalidateQueries({queryKey:["checkout/report-orders/",t]}),"Muvaffaqiyatli tasdiqlandi")})}const h=!!A().allPaths.includes("checkout/summary/");return i.jsx("div",{className:"space-y-4",children:i.jsxs(ne,{value:t.payment_type||"cash",children:[i.jsx(T,{value:"cash",children:i.jsx(L,{loading:o,columns:ye({handlePay:d}),data:(u=(l=n==null?void 0:n.results)==null?void 0:l.filter(c=>{var f;return((f=c==null?void 0:c.to_orders)==null?void 0:f.length)>0}))==null?void 0:u.map(c=>({...c,subRows:(c==null?void 0:c.to_orders)||[]})),paginationProps:{totalPages:n==null?void 0:n.total_pages},head:i.jsx("div",{className:"!flex-col !items-start",children:i.jsx(F,{paramName:"payment_type",options:[{label:"Naqd",value:"cash"},{label:"Pul o'tkazish",value:"transfer"},{label:"Reyestr",value:"reyestr"}].slice(0,h?3:2)})})})}),i.jsx(T,{value:"transfer",children:i.jsx(L,{loading:r,columns:xe({handlePay:d}),data:(C=(x=s==null?void 0:s.results)==null?void 0:x.filter(c=>c.to_orders.length>0))==null?void 0:C.map(c=>({...c,subRows:c.to_orders})),paginationProps:{totalPages:s==null?void 0:s.total_pages},head:i.jsx("div",{className:"!flex-col !items-start",children:i.jsx(F,{paramName:"payment_type",options:[{label:"Naqd",value:"cash"},{label:"Pul o'tkazish",value:"transfer"},{label:"Reyestr",value:"reyestr"}].slice(0,h?3:2)})})})}),i.jsx(T,{value:"reyestr",children:i.jsx(ge,{})})]})})},Ke=te("/_main/_manager/report")({component:()=>i.jsx(fe,{})});export{Ke as Route};
